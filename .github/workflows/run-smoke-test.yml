name: run-smoke-test

on:
  workflow_call:

permissions:
  contents: read

jobs:
  unit-test:
    name: unit test
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: setup
        uses: ./.github/actions/setup
      - name: unit test `puffin`
        run: just test puffin x86_64-unknown-linux-gnu "" ""
      - name: unit test `security-claims`
        run: just test security-claims x86_64-unknown-linux-gnu "" ""
      - name: unit test `tlspuffin`
        run: just test tlspuffin x86_64-unknown-linux-gnu "" "--no-default-features"
      - name: unit test `sshpuffin`
        run: just test tlspuffin x86_64-unknown-linux-gnu "" "--no-default-features"

  tlspuffin:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: setup
        uses: ./.github/actions/setup
      - name: build OpenSSL dependency
        uses: ./.github/actions/mk_vendor
        with:
          vendor: "openssl"
          preset: "openssl111j"
          name: "openssl111j-sancov"
          options: "sancov"
      - name: build `tlspuffin`
        run: just run cargo build --profile=release --features=openssl111j --bin tlspuffin
      - name: run `tlspuffin help`
        run: just run cargo run --profile=release --features=openssl111j --bin tlspuffin -- help
      - name: run `tlspuffin seed`
        run: just run cargo run --profile=release --features=openssl111j --bin tlspuffin -- seed && [[ -d ./seeds ]]
      - name: run `tlspuffin execute` on seeds
        run: just run cargo run --profile=release --features=openssl111j --bin tlspuffin -- execute-traces ./seeds

  sshpuffin:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: setup
        uses: ./.github/actions/setup
      - name: build `sshpuffin`
        run: just run cargo build --profile=release --bin sshpuffin
      - name: run `sshpuffin help`
        run: just run cargo run --profile=release --bin sshpuffin -- help
      - name: run `sshpuffin seed`
        run: just run cargo run --profile=release --bin sshpuffin -- seed && [[ -d ./seeds ]]
      - name: run `sshpuffin execute` on seeds
        run: just run cargo run --profile=release --bin sshpuffin -- execute-traces ./seeds
