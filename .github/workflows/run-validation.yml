name: run-validation

on:
  workflow_call:
    inputs:
      profile: # one of ['none', 'fast', 'full']
        type: string
        required: true

permissions:
    contents: read

jobs:
  configure:
    runs-on: ubuntu-22.04
    outputs:
      checks: ${{ steps.configure-checks.outputs.checks }}
    defaults:
      run:
        shell: bash
    steps:
      - id: configure-checks
        name: Configure Validation
        run: |
          #!/usr/bin/env bash
          case "${{ inputs.profile }}" in
            none) CI_CHECKS=();;
            fast) CI_CHECKS=( check smoke docs base );;
            full) CI_CHECKS=( check smoke docs base extra );;
            *)
              printf "error: unknown validation profile '%s'\n" "${{ inputs.profile }}""
              exit 1
              ;;
          esac

          json_result=$(printf ', "%s"' "x" "${CI_CHECKS[@]}")
          json_result="[${json_result:6}]"

          printf 'checks=%s\n' "${json_result}" >> "${GITHUB_OUTPUT}"

      - id: print-configuration
        name: Display Configuration
        run: |
          #!/usr/bin/env bash
          printf 'Finished configuration job:\n'
          printf '- received validation profile: %s\n' '${{ inputs.profile }}'
          printf '- selected validation checks: %s\n' '${{ steps.configure-checks.outputs.checks }}'

  check:
    needs: [configure]
    if: ${{ contains(fromJson(needs.configure.outputs.checks), 'check') }}
    uses: ./.github/workflows/run-checks.yml

  smoke-test:
    needs: [configure]
    if: ${{ contains(fromJson(needs.configure.outputs.checks), 'smoke') }}
    uses: ./.github/workflows/run-smoke-test.yml

  docs:
    needs: [configure]
    if: ${{ contains(fromJson(needs.configure.outputs.checks), 'docs') }}
    uses: ./.github/workflows/build-docs.yml

  run-benchmarks:
    needs: [configure, smoke-test]
    if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
    uses: ./.github/workflows/run-benchmarks.yml

  test-tlspuffin:
    needs: [configure, smoke-test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - vendor: openssl
            preset: openssl111k
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - vendor: openssl
            preset: openssl111j
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - vendor: openssl
            preset: openssl101f
            options: sancov,asan
            features: asan
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - vendor: openssl
            preset: openssl102u
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - vendor: libressl
            preset: libressl
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - vendor: wolfssl
            preset: wolfssl430
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - vendor: wolfssl
            preset: wolfssl510
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - name: wolfssl510
            vendor: wolfssl
            preset: wolfssl510
            options: sancov
            features: fix-CVE-2022-25640,fix-CVE-2022-39173
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - name: wolfssl510-skip
            vendor: wolfssl
            preset: wolfssl510
            options: sancov
            features: fix-CVE-2022-25638,fix-CVE-2022-39173
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - vendor: wolfssl
            preset: wolfssl520
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - vendor: wolfssl
            preset: wolfssl520
            options: sancov,asan
            features: asan
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - vendor: wolfssl
            preset: wolfssl530
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - vendor: wolfssl
            preset: wolfssl530
            options: sancov,asan
            features: asan
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - vendor: wolfssl
            preset: wolfssl540
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}
          - name: wolfssl540-sdos2
            vendor: wolfssl
            preset: wolfssl540
            options: sancov
            features: wolfssl-disable-postauth,fix-CVE-2022-39173
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - name: wolfssl530-cdos
            vendor: wolfssl
            preset: wolfssl530,
            options: sancov
            features: fix-CVE-2022-39173
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - vendor: wolfssl
            preset: wolfssl540
            options: sancov,asan
            features: asan
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - name: wolfssl540-buf
            vendor: wolfssl
            preset: wolfssl540
            options: sancov
            features: fix-CVE-2022-42905
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - name: wolfssl540-heap
            vendor: wolfssl
            preset: wolfssl540
            options: sancov,asan
            features: asan,fix-CVE-2022-39173
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - name: wolfssl540_asan-perf
            vendor: wolfssl
            preset: wolfssl540
            options: sancov,asan
            features: asan,fix-CVE-2022-39173,fix-CVE-2022-42905
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - name: wolfssl540-perf
            vendor: wolfssl
            preset: wolfssl540
            options: sancov
            features: fix-CVE-2022-39173,fix-CVE-2022-42905
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - vendor: boringssl
            preset: boringssl202403
            options: sancov
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'extra') }}
          - vendor: boringssl
            preset: boringssl202403
            options: sancov,asan
            features: asan
            if: ${{ contains(fromJson(needs.configure.outputs.checks), 'base') }}

    uses: ./.github/workflows/run-tlspuffin-tests.yml
    name: tlspuffin ${{ matrix.name || format('{0}:{1}-{2}-{3}', matrix.vendor, matrix.preset, matrix.options, matrix.features) }}
    with:
      vendor: ${{ matrix.vendor }}
      preset: ${{ matrix.preset }}
      options: ${{ matrix.options }}
      features: ${{ matrix.features }}
      if: ${{ matrix.if }}
