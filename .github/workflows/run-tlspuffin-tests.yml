name: Test tlspuffin on Linux

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      vendor:
        required: true
        type: string
      preset:
        required: true
        type: string
      options:
        required: false
        type: string
        default: ''
      features:
        required: false
        type: string
        default: ''
      if:
        required: false
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  tlspuffin-tests:
    name: cargo test
    runs-on: ubuntu-22.04
    if: ${{ inputs.if }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - name: setup
        uses: ./.github/actions/setup
        with:
          key: ${{ inputs.vendor }}-${{ inputs.preset }}-${{ inputs.features }}
      - name: build vendor library
        if: ${{ contains(fromJson('["openssl"]'), inputs.vendor) }}
        uses: ./.github/actions/mk_vendor
        with:
          vendor: "${{ inputs.vendor }}"
          preset: "${{ inputs.preset }}"
          name: "${{ inputs.preset }}-${{ join(fromJson(format('[{0}]', inputs.options)), '-') }}"
          options: "${{ inputs.options }}"
      - name: test
        run: just test tlspuffin x86_64-unknown-linux-gnu "${{ inputs.preset }},${{ inputs.features }}" ""
